syntax = "proto3";

package rpc;

service Connect {
  rpc GetCollection(CollectionRequest) returns (CollectionResponse) {}
  rpc GetDocument(DocumentRequest) returns (DocumentResponse) {}
  rpc GetNextArgs(NextArgsRequest) returns (NextArgsResponse) {}
  rpc DoPublish(PublishRequest) returns (NextArgsResponse) {}
}

message CollectionRequest {
  string schema_id = 1;
  optional Pagination pagination = 2;
  optional Order order = 3;
  repeated FilterSetting filter = 4;
}

message Pagination {
  uint64 first = 1;
  optional PaginationCursor after = 2;
  repeated PaginationField fields = 3;
}

enum PaginationField {
  TotalCount = 0;
  HasNextPage = 1;
  HasPreviousPage = 2;
  StartCursor = 3;
  EndCursor = 4;
}

message PaginationCursor {
  string operation_cursor = 1;
  optional string root_operation_cursor = 2;
  optional string root_view_id = 3;
}

message Order {
  oneof field {
    MetaField meta = 1;
    string field_name = 2;
  }
  Direction direction = 3;
}

enum MetaField {
  DocumentId = 0;
  DocumentViewId = 1;
  Owner = 2;
  Edited = 3;
  Deleted = 4;
}

enum Direction {
  Ascending = 0;
  Descending = 1;
}

message FilterSetting {
  oneof filter_by {
    MetaField meta = 1;
    Field field = 2;
  }
  FilterOperator operator = 3;
  // bool exclusive = 3;
}

enum FilterOperator {
  In = 0;
  NotIn = 1;
  Eq = 2;
  NotEq = 3;
  Gt = 4;
  Gte = 5;
  Lt = 6;
  Lte = 7;
  Contains = 8;
  NotContains = 9;
}

message CollectionResponse {
  PaginationData pagination = 1;
  repeated DocumentCursorTuple documents = 2;
}

message DocumentCursorTuple {
  PaginationCursor cursor = 1;
  Document document = 2;
}

message PaginationData {
  uint64 total_count = 1;
  bool has_next_page = 2;
  bool has_previous_page = 3;
  optional PaginationCursor start_cursor = 4;
  optional PaginationCursor end_cursor = 5;
}

message DocumentRequest {
  optional string document_id = 1;
  optional string document_view_id = 2;
}

message DocumentResponse {
  optional Document document = 1;
}

message DocumentMeta {
  string document_id = 1;
  string view_id = 2;
  string owner = 3;
}

message Document {
  DocumentMeta meta = 1;
  repeated Field fields = 2;
}

enum FieldType {
  Doc = 0;
  String = 1;
  Int = 2;
  Float = 3;
  Bool = 4;
  Bytes = 5;
}

message Field {
  // FieldType data_type = 1;
  string name = 1;
  oneof value {
    Document rel_val = 2;
    DocumentList rel_list_val = 3;
    Document pinned_rel_val = 4;
    DocumentList pinned_rel_list_val = 5;
    string string_val = 6;
    sint64 int_val = 7;
    double float_val = 8;
    bool bool_val = 9;
    bytes byte_val = 10;
  }
}

message DocumentList {
  repeated Document documents = 1;
}

message NextArgsRequest {
  string public_key = 1;
  optional string document_view_id = 2;
}

message PublishRequest {
  string entry = 1;
  string operation = 2;
}

message NextArgsResponse {
  uint64 log_id = 1;
  uint64 seq_num = 2;
  optional string backlink = 3;
  optional string skiplink = 4;
}